// Generated by CoffeeScript 1.4.0
(function() {
  var LINE_PREFIX, after, childProcess, compact, compactMap, flatten, isString, keys, map, watch, wrap, _ref,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  watch = require('watch');

  childProcess = require('child_process');

  _ref = require('underscore'), after = _ref.after, wrap = _ref.wrap, map = _ref.map, flatten = _ref.flatten, compact = _ref.compact, isString = _ref.isString, keys = _ref.keys;

  LINE_PREFIX = "---";

  compactMap = function(arr, fn) {
    return compact(map(flatten(arr), fn));
  };

  module.exports = function(path, command, options) {
    var Reaktr, args, exclude, excluded, include, longRunning, notIncluded;
    if (options == null) {
      options = {};
    }
    longRunning = options.longRunning, exclude = options.exclude, include = options.include;
    if (include != null) {
      include = RegExp(include);
      notIncluded = function() {
        return !include.test.apply(include, arguments);
      };
    }
    if (exclude != null) {
      exclude = RegExp(exclude);
      excluded = function() {
        return exclude.test.apply(exclude, arguments);
      };
    }
    args = [command];
    args.unshift('-c');
    Reaktr = (function() {

      function Reaktr() {
        this.startProcess = __bind(this.startProcess, this);

        this.parseFiles = __bind(this.parseFiles, this);

        this.onChange = __bind(this.onChange, this);

      }

      Reaktr.prototype.start = function() {
        this.log("");
        this.log("Observing files in `" + path + "` and running `" + command + "` on changes");
        this.log("");
        if (include != null) {
          this.log("Include files matching: /" + include + "/");
        }
        if (exclude != null) {
          this.log("Exclude files matching: /" + exclude + "/");
        }
        if (longRunning) {
          this.process = this.startProcess();
          this.startProcess = this.processRestarter(this.startProcess);
        }
        this.onChange = after(2, this.onChange);
        return watch.watchTree(path, this.onChange);
      };

      Reaktr.prototype.log = function(message) {
        return console.log("" + LINE_PREFIX + " " + message);
      };

      Reaktr.prototype.onChange = function(files) {
        var file, _i, _len;
        files = this.parseFiles(files);
        if (!files.length) {
          return;
        }
        this.log("");
        this.log("Change detected:");
        for (_i = 0, _len = files.length; _i < _len; _i++) {
          file = files[_i];
          this.log("." + file);
        }
        this.log("");
        return this.startProcess();
      };

      Reaktr.prototype.parseFiles = function(files) {
        if (!isString(files)) {
          files = keys(files);
        }
        return compactMap([files], this.parseFile);
      };

      Reaktr.prototype.parseFile = function(file) {
        file = file.replace(path, '') || '/';
        if (typeof notIncluded === "function" ? notIncluded(file) : void 0) {
          file = null;
        }
        if (typeof excluded === "function" ? excluded(file) : void 0) {
          file = null;
        }
        return file;
      };

      Reaktr.prototype.startProcess = function() {
        this.log("Running `" + command + "`");
        this.log("");
        return childProcess.spawn("sh", args, {
          stdio: 'inherit'
        });
      };

      Reaktr.prototype.processRestarter = function(startFn) {
        var _this = this;
        return function() {
          _this.process.on('exit', function(code) {
            _this.log("");
            _this.log("PID " + _this.process.pid + " exited with " + code);
            _this.log("");
            return _this.process = startFn();
          });
          _this.log("Killing process with PID " + _this.process.pid);
          _this.log("kill `pstree -p " + _this.process.pid + " | sed 's/(/\\n(/g' | grep '(' | sed 's/(\\(.*\\)).*/\\1/' | tr \"\\n\" \" \"`");
          return childProcess.exec("kill `pstree -p " + _this.process.pid + " | sed 's/(/\\n(/g' | grep '(' | sed 's/(\\(.*\\)).*/\\1/' | tr \"\\n\" \" \"`");
        };
      };

      return Reaktr;

    })();
    return new Reaktr();
  };

}).call(this);
